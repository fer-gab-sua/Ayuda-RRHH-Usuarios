{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ documento.titulo }} - Portal RRHH{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Información principal del documento -->
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4><i class="fas fa-file-alt"></i> {{ documento.titulo }}</h4>
                            <small class="text-muted">
                                Subido el {{ documento.fecha_subida|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        <div class="col-auto">
                            {% if documento.estado == 'pendiente' %}
                                <span class="badge bg-warning text-dark fs-6">
                                    <i class="fas fa-clock"></i> Pendiente
                                </span>
                            {% elif documento.estado == 'aprobado' %}
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check"></i> Aprobado
                                </span>
                            {% elif documento.estado == 'rechazado' %}
                                <span class="badge bg-danger fs-6">
                                    <i class="fas fa-times"></i> Rechazado
                                </span>
                            {% elif documento.estado == 'requiere_aclaracion' %}
                                <span class="badge bg-info fs-6">
                                    <i class="fas fa-question"></i> Requiere Aclaración
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Información del Documento</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Tipo:</strong></td>
                                    <td>{{ documento.tipo_documento.nombre }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Archivo:</strong></td>
                                    <td>
                                        {% if documento.archivo %}
                                            {{ documento.nombre_archivo }}
                                            <br>
                                            <a href="{% url 'documentos:ver_archivo' documento.id %}" 
                                               class="btn btn-sm btn-primary mt-1" 
                                               target="_blank">
                                                <i class="fas fa-download"></i> Ver/Descargar
                                            </a>
                                        {% else %}
                                            <em class="text-muted">No hay archivo adjunto</em>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if documento.fecha_desde %}
                                <tr>
                                    <td><strong>Período:</strong></td>
                                    <td>
                                        Del {{ documento.fecha_desde|date:"d/m/Y" }}
                                        {% if documento.fecha_hasta %}
                                            al {{ documento.fecha_hasta|date:"d/m/Y" }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Estado y Revisión</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Estado:</strong></td>
                                    <td>
                                        {% if documento.estado == 'pendiente' %}
                                            <span class="text-warning"><i class="fas fa-clock"></i> Pendiente de revisión</span>
                                        {% elif documento.estado == 'aprobado' %}
                                            <span class="text-success"><i class="fas fa-check"></i> Aprobado</span>
                                        {% elif documento.estado == 'rechazado' %}
                                            <span class="text-danger"><i class="fas fa-times"></i> Rechazado</span>
                                        {% elif documento.estado == 'requiere_aclaracion' %}
                                            <span class="text-info"><i class="fas fa-question"></i> Requiere aclaración</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if documento.fecha_revision %}
                                <tr>
                                    <td><strong>Fecha de revisión:</strong></td>
                                    <td>{{ documento.fecha_revision|date:"d/m/Y H:i" }}</td>
                                </tr>
                                {% endif %}
                                {% if documento.revisado_por %}
                                <tr>
                                    <td><strong>Revisado por:</strong></td>
                                    <td>{{ documento.revisado_por.get_full_name|default:documento.revisado_por.username }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    {% if documento.descripcion %}
                    <div class="mt-3">
                        <h6>Descripción</h6>
                        <p class="text-muted">{{ documento.descripcion }}</p>
                    </div>
                    {% endif %}

                    {% if documento.observaciones_rrhh %}
                    <div class="mt-3">
                        <h6>Comentarios de RRHH</h6>
                        {% if documento.estado == 'aprobado' %}
                        <div class="alert alert-success">
                        {% elif documento.estado == 'rechazado' %}
                        <div class="alert alert-danger">
                        {% else %}
                        <div class="alert alert-info">
                        {% endif %}
                            {{ documento.observaciones_rrhh }}
                        </div>
                    </div>
                    {% endif %}

                    {% if documento.inasistencia %}
                    <div class="mt-3">
                        <h6>Relacionado con Inasistencia</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-calendar-times"></i>
                            Este documento justifica la inasistencia del 
                            <strong>{{ documento.inasistencia.fecha_desde|date:"d/m/Y" }}</strong>
                            {% if documento.inasistencia.fecha_hasta %}
                                al <strong>{{ documento.inasistencia.fecha_hasta|date:"d/m/Y" }}</strong>
                            {% endif %}
                            <br>
                            <small class="text-muted">Motivo: {{ documento.inasistencia.motivo }}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Historial de cambios -->
            {% if historial %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Historial de Cambios</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for evento in historial %}
                        <div class="timeline-item">
                            <div class="timeline-marker">
                                {% if evento.accion == 'creado' %}
                                    <i class="fas fa-plus text-primary"></i>
                                {% elif evento.accion == 'editado' %}
                                    <i class="fas fa-edit text-warning"></i>
                                {% elif evento.accion == 'aprobado' %}
                                    <i class="fas fa-check text-success"></i>
                                {% elif evento.accion == 'rechazado' %}
                                    <i class="fas fa-times text-danger"></i>
                                {% elif evento.accion == 'requiere_aclaracion' %}
                                    <i class="fas fa-question text-info"></i>
                                {% else %}
                                    <i class="fas fa-circle text-secondary"></i>
                                {% endif %}
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <strong>
                                        {% if evento.accion == 'creado' %}
                                            Documento creado
                                        {% elif evento.accion == 'editado' %}
                                            Documento editado
                                        {% elif evento.accion == 'aprobado' %}
                                            Documento aprobado
                                        {% elif evento.accion == 'rechazado' %}
                                            Documento rechazado
                                        {% elif evento.accion == 'requiere_aclaracion' %}
                                            Solicitud de aclaración
                                        {% else %}
                                            {{ evento.accion|title }}
                                        {% endif %}
                                    </strong>
                                    <small class="text-muted">{{ evento.fecha|date:"d/m/Y H:i" }}</small>
                                </div>
                                <div class="text-muted">
                                    por {{ evento.usuario.get_full_name|default:evento.usuario.username }}
                                </div>
                                {% if evento.comentarios %}
                                <div class="mt-1">
                                    <em>"{{ evento.comentarios }}"</em>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Acciones disponibles -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Acciones</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if documento.archivo %}
                            <a href="{% url 'documentos:ver_archivo' documento.id %}" 
                               class="btn btn-primary" 
                               target="_blank">
                                <i class="fas fa-eye"></i> Ver Documento
                            </a>
                        {% endif %}

                        {% if documento.puede_editar %}
                            <a href="{% url 'documentos:editar' documento.id %}" 
                               class="btn btn-warning">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <button class="btn btn-danger" 
                                    onclick="eliminarDocumento({{ documento.id }})">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        {% endif %}

                        <a href="{% url 'documentos:mis_documentos' %}" 
                           class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver a Mis Documentos
                        </a>
                    </div>
                </div>
            </div>

            <!-- Información del estado -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Estado del Documento</h6>
                </div>
                <div class="card-body">
                    {% if documento.estado == 'pendiente' %}
                        <div class="alert alert-warning">
                            <h6>Pendiente de Revisión</h6>
                            <p class="mb-0">Tu documento está en cola para ser revisado por el equipo de RRHH. Te notificaremos cuando haya actualizaciones.</p>
                        </div>
                    {% elif documento.estado == 'aprobado' %}
                        <div class="alert alert-success">
                            <h6>Documento Aprobado</h6>
                            <p class="mb-0">¡Excelente! Tu documento ha sido aprobado por RRHH y está oficialmente validado en el sistema.</p>
                        </div>
                    {% elif documento.estado == 'rechazado' %}
                        <div class="alert alert-danger">
                            <h6>Documento Rechazado</h6>
                            <p class="mb-0">Tu documento ha sido rechazado. Revisa los comentarios de RRHH y considera subir un nuevo documento con las correcciones necesarias.</p>
                        </div>
                    {% elif documento.estado == 'requiere_aclaracion' %}
                        <div class="alert alert-info">
                            <h6>Requiere Aclaración</h6>
                            <p class="mb-0">RRHH necesita información adicional sobre tu documento. Revisa los comentarios y edita el documento para proporcionar las aclaraciones solicitadas.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEliminarLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar este documento? Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 0;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: white;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: -11px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #dee2e6;
}
</style>

<script>
function eliminarDocumento(documentoId) {
    const modal = new bootstrap.Modal(document.getElementById('modalEliminar'));
    modal.show();
    
    document.getElementById('btnConfirmarEliminar').onclick = function() {
        const formData = new FormData();
        formData.append('documento_id', documentoId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "documentos:eliminar" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "documentos:mis_documentos" %}';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el documento');
        });

        modal.hide();
    };
}
</script>
{% endblock %}
